handle_f_2d = figure;
axis equal;

%%
pixel_coordinates = [
430  , 253.11429267637425 , 164.82936261856895 ;
430  , 253.10041037832895 , 164.83641169301302 ;
430  , 253.10369245248413 , 164.8354049934375 ;
435  , 253.1191908082852 , 164.84014164839652 ;
435  , 253.1199551079349 , 164.84079783284434 ;
435  , 253.12543051549926 , 164.84563166260625 ;
435  , 253.12292985280402 , 164.8440501754804 ;
435  , 253.12528212017347 , 164.8442345096821 ;
435  , 253.12139756091034 , 164.83823733236537 ;
435  , 253.11085992923128 , 164.83920228454372 ;
435  , 253.11220874505725 , 164.82960732635993 ;
435  , 253.16004553792362 , 164.8261394345913 ;
435  , 253.1207237900018 , 164.83309935800114 ;
435  , 253.12813734956393 , 164.83854205894593 ;
435  , 253.31734083242281 , 164.8761107332303 ;
435  , 225.2050653007162 , 160.23587252381262 ;
435  , 264.57728072032603 , 161.0891038157301 ;
435  , 237.85301012522598 , 165.7447768835862 ;
440  , 230.75648792102487 , 173.8640171270256 ;
440  , 226.15561500610022 , 179.0802354742079 ;
440  , 226.38230157808945 , 178.85197869123712 ;
440  , 240.94024812289018 , 162.4156017374147 ;
440  , 244.98689652078946 , 158.25103935831334 ;
440  , 247.1819632481401 , 155.2293036277224 ;
440  , 249.60975552677115 , 152.68167212296876 ;
440  , 251.0755436167259 , 151.12232764460686 ;
440  , 253.23046850295162 , 148.88344271746277 ;
440  , 254.74104516197596 , 147.362545664723 ;
440  , 257.32814221356017 , 144.28621258355858 ;
440  , 274.93214118346566 , 124.65643302290145 ;
440  , 267.17957051765114 , 120.19790795911761 ;
440  , 259.1684145005401 , 117.42572102406818 ;
440  , 254.20834904135629 , 116.10071220379129 ;
445  , 249.55665441045366 , 113.5104466613984 ;
445  , 244.0596131337659 , 111.76581465896982 ;
445  , 214.79772471462678 , 109.79575657995369 ;
445  , 209.8766310335539 , 109.5695953004633 ;
445  , 208.46761203615847 , 109.13003062546791 ;
445  , 202.0861476643223 , 109.80480776042923 ;
445  , 193.70689482709744 , 109.94509753018086 ;
445  , 184.72310453166273 , 110.2198470320282 ;
445  , 176.37236045440608 , 110.1912968818354 ;
445  , 150.37849246993056 , 110.87927055726747 ;
445  , 144.47595911906467 , 108.19374271981336 ;
445  , 134.2661482196043 , 107.84815997197633 ;
450  , 136.2477883759477 , 102.1370851684157 ;
450  , 154.12086910404125 , 96.68490778106784 ;
450  , 156.24983858490202 , 96.55300868809078 ;
450  , 165.3752013442265 , 95.92437094230135 ;
450  , 169.46311058061934 , 95.8777506770359 ;
450  , 173.2693813730722 , 96.19707639303508 ;
455  , 179.21370009755455 , 96.17457330248672 ;
455  , 187.60833688985628 , 96.78228300954795 ;
455  , 194.3289131459661 , 96.83055669775021 ;
455  , 202.03816314880035 , 97.48472057754198 ;
455  , 210.03435182761308 , 97.86376271809272 ;
455  , 219.22655324257104 , 98.71614970663938 ;
455  , 225.6672235328059 , 99.92130780901226 ;
455  , 233.09167196030376 , 100.89285885131953 ;
455  , 241.32534734140157 , 101.86010149140772 ;
455  , 252.32604809428656 , 103.33223789373154 ;
455  , 265.02723599118764 , 102.90638272647472 ;
455  , 274.008459758229 , 102.77919588340075 ;
460  , 284.683045638289 , 102.52252767472949 ;
460  , 295.7050131284854 , 101.53217735235151 ;
460  , 300.95293103911956 , 97.93645653037515 ;
460  , 291.6686785747808 , 96.7747358931204 ;
460  , 291.67033722780997 , 96.75431741704945 ;
460  , 291.5810723499906 , 96.80837491890541 ;
460  , 292.1953836692756 , 92.61695263000142 ;
460  , 237.08705905324828 , 83.17343421553798 ;
460  , 239.37495298758577 , 88.37126755684508 ;
465  , 241.44916199916344 , 91.40164860647886 ;
465  , 242.54124912187478 , 93.08286993809358 ;
465  , 243.43345210462948 , 95.19538740959281 ;
465  , 245.4545259130074 , 98.76796053203579 ;
465  , 247.38320396883245 , 101.11594064375129 ;
465  , 249.62945827127535 , 103.93599889567311 ;
465  , 252.02730496027556 , 107.14962290257641 ;
465  , 256.3130734787977 , 113.00653495489142 ;
465  , 266.961730150435 , 129.06759683724016 ;
465  , 257.52480594710454 , 136.764465177831 ;
465  , 270.79882869618666 , 138.17095593970893 ;
465  , 260.40995469211896 , 142.26159885286003 ;
470  , 244.02536533753127 , 150.3587803879363 ;
470  , 218.80286210285658 , 163.03155254193283 ;
470  , 192.36618006091007 , 175.7820677570483 ;
470  , 169.60051575975166 , 186.73154383730238 ;
470  , 161.29450492876637 , 190.16003805103543 ;
470  , 190.61004489650747 , 184.6927619188586 ;
470  , 223.9096819691862 , 178.49085739672836 ;
470  , 219.1741146439682 , 170.26522223845384 ;
470  , 257.39653751145295 , 163.43802218873842 ;
470  , 256.9252577316347 , 164.20702197424856 ;
535  , 256.9396465055422 , 164.19707072572393 ;
535  , 257.00375063469176 , 164.01505209690743 ;
535  , 257.1837591906876 , 164.60271440982265 ;
535  , 259.50118779799647 , 163.41197860687126 ;
535  , 258.11580879031663 , 163.63886942501003 ;
];

%%
pixel_coordinates(:,3) = 190-pixel_coordinates(:,3);

%%
hold on
plot(pixel_coordinates(:,2),pixel_coordinates(:,3),'b');
plot(pixel_coordinates(:,2),pixel_coordinates(:,3),'bx');
axis ([0 352 0 240])
%  axis ([100 325 0 150])
axis equal

for i_ = 1:size(pixel_coordinates,1) 
    text(pixel_coordinates(i_,2),pixel_coordinates(i_,3),strcat('\color{magenta} ',num2str(i_)))
end

%%

world_coordinates = [
545  , 2.2518709144560742 , 1.1630717404023962 , 0.615 ;
545  , 2.176444199482325 , 1.1225078767824883 , 0.615 ;
545  , 2.1300879258118433 , 1.0992082638806104 , 0.615 ;
545  , 2.115193994898596 , 1.1334871130120738 , 0.615 ;
545  , 2.0566536563815507 , 1.1291339887739322 , 0.615 ;
545  , 1.9857166748445674 , 1.1244546416117907 , 0.615 ;
545  , 1.9580019903987986 , 1.1696364897025031 , 0.615 ;
545  , 1.8867963214817516 , 1.1630781364930742 , 0.615 ;
545  , 1.8040415653523254 , 1.1588307343790107 , 0.615 ;
550  , 1.7230454196468603 , 1.2149048016028574 , 0.615 ;
550  , 1.6644112931404798 , 1.2298023486597291 , 0.615 ;
550  , 1.596045048906719 , 1.2464887478843538 , 0.615 ;
550  , 1.5392261066156998 , 1.2563392841115564 , 0.615 ;
550  , 1.4696740298018383 , 1.267867691098628 , 0.615 ;
550  , 1.4317023735343093 , 1.2569290027473354 , 0.615 ;
550  , 1.3736057442345155 , 1.235094074777221 , 0.615 ;
550  , 1.3180016737312144 , 1.2075928827499156 , 0.615 ;
550  , 1.263291560458985 , 1.175054902260863 , 0.615 ;
550  , 1.202365245380223 , 0.9955651489587938 , 0.615 ;
550  , 1.1845944802522728 , 0.9620255881811803 , 0.615 ;
550  , 1.1845944802522728 , 0.9620255881811803 , 0.615 ;
550  , 1.1871446629526554 , 0.9593267284224445 , 0.615 ;
550  , 1.3455247396506684 , 0.8611385830066536 , 0.615 ;
550  , 1.8849240221248431 , 0.5515516971835766 , 0.615 ;
550  , 1.7755225068819513 , 0.7927636399101543 , 0.615 ;
550  , 1.7151111661149356 , 0.9218010801006464 , 0.615 ;
550  , 1.6812434081063723 , 0.9853774138596372 , 0.615 ;
550  , 1.6491157123833928 , 1.0488772311456667 , 0.615 ;
550  , 1.586879772264211 , 1.1667900103381776 , 0.615 ;
550  , 1.557358610915621 , 1.2347635800951133 , 0.615 ;
550  , 1.5111065815163855 , 1.323166873618968 , 0.615 ;
550  , 1.4663234881356737 , 1.4096105807202302 , 0.615 ;
550  , 1.412953470287718 , 1.5324275043122024 , 0.615 ;
550  , 1.2242498182049033 , 1.8112837847646106 , 0.615 ;
550  , 1.1855445639349977 , 1.944146521531571 , 0.615 ;
550  , 1.210880891923415 , 2.0476684994059093 , 0.615 ;
550  , 1.2356350924023551 , 2.1269309096625193 , 0.615 ;
550  , 1.2781658195972194 , 2.2778922910429293 , 0.615 ;
550  , 1.3351544958339594 , 2.4289036930478085 , 0.615 ;
550  , 1.38684548364011 , 2.5756462710169084 , 0.615 ;
550  , 1.4224275065694245 , 2.68157848147579 , 0.615 ;
550  , 1.4224275065694245 , 2.68157848147579 , 0.615 ;
550  , 1.3289491646641651 , 2.5647275547339965 , 0.615 ;
550  , 1.2419794594308504 , 2.4843000793934764 , 0.615 ;
550  , 1.156371390890424 , 2.4019128849809435 , 0.615 ;
550  , 1.0343055807858463 , 2.2974883678053866 , 0.615 ;
550  , 1.0343055807858463 , 2.2974883678053866 , 0.615 ;
550  , 1.0343055807858463 , 2.2974883678053866 , 0.615 ;
550  , 1.0343055807858463 , 2.2974883678053866 , 0.615 ;
550  , 1.0343055807858463 , 2.2974883678053866 , 0.615 ;
550  , 1.0343055807858463 , 2.2974883678053866 , 0.615 ;
550  , 1.0343055807858463 , 2.2974883678053866 , 0.615 ;
];

%%

handle_f_3d = figure;
axis equal;
plot3( world_coordinates(:,2) , world_coordinates(:,3) , world_coordinates(:,4) , 'bx');
hold on;
plot3( world_coordinates(:,2) , world_coordinates(:,3) , world_coordinates(:,4) );
axis equal;
axis ([0 2.2 0 2.7 0 1.0])
axis equal;
xlabel('X');  ylabel('Y');  zlabel('Z');  grid on;

for i_ = 1:size(world_coordinates,1) 
    text( world_coordinates(i_,2), world_coordinates(i_,3), world_coordinates(i_,4), strcat('\color{magenta} ', ...
       num2str(i_+47)) );  
    %    num2str( i_ )) );
    % data above has 47 records missing for world
    % coordinates
end


%%
cameraParams_Intrinsics = [
    519.90         0    320;
         0    518.95    120;
         0         0    1 ];

the_pixel_coordinates = pixel_coordinates(48:93, 2:3);

the_world_coordinates = world_coordinates(1:46,2:4);

% [R,T,Xc,best_solution]=efficient_pnp(observed_world_coordinates, observed_cam_coordinates, cameraParams.IntrinsicMatrix');  % [R,T,Xc,best_solution]=efficient_pnp(x3d_h,x2d_h,A)
[Re,Te,Xce,best_solutione]=efficient_pnp( the_world_coordinates, the_pixel_coordinates, cameraParams_Intrinsics );  
R = Re; T = Te; Xc = Xce; best_solution = best_solutione;
draw_axes(R, T, '\color{magenta} eff pnp', 1);

%  m x 2,  m x 3 , 
%  Camera parameters, specified as a cameraParameters or cameraIntrinsics object
%  The function does not account for lens distortion. 
%    You can either undistort the images using the undistortImage function before detecting the image points, 
%    or you can undistort the image points themselves using the undistortPoints function.
% [worldOrientation,worldLocation] = estimateWorldCameraPose(imagePoints,worldPoints,cameraParams);
????
%[worldOrientation,worldLocation] = estimateWorldCameraPose(the_pixel_coordinates,the_world_coordinates,cameraParams)
??????

the_pixel_coordinates = pixel_coordinates(93:-2:48, 2:3);
the_world_coordinates = world_coordinates(46:-2:1,2:4);
[Re,Te,Xce,best_solutione]=efficient_pnp( the_world_coordinates, the_pixel_coordinates, cameraParams_Intrinsics );  
R = Re; T = Te; Xc = Xce; best_solution = best_solutione;
draw_axes(R, T, '\color{magenta} eff pnp', 1.0);


% best 
the_pixel_coordinates = pixel_coordinates(93:-3:48, 2:3);
the_world_coordinates = world_coordinates(46:-3:1,2:4);
[Re,Te,Xce,best_solutione]=efficient_pnp( the_world_coordinates, the_pixel_coordinates, cameraParams_Intrinsics );  
R = Re; T = Te; Xc = Xce; best_solution = best_solutione;
draw_axes(R, T, '\color{magenta} at-3', 1.0);
draw_axes(R, [ T(2); -T(1); T(3)], '\color{magenta} at-3-b', 1.0);
axis([-2 3 -2 3 0 1.5])


the_pixel_coordinates = pixel_coordinates(93:-3:48, 2:3);
the_world_coordinates = world_coordinates(46:-3:1,2:4);
[Re,Te,Xce,best_solutione]=efficient_pnp( the_world_coordinates, the_pixel_coordinates, cameraParams_Intrinsics );  

the_pixel_coordinates = pixel_coordinates(93:-4:48, 2:3);
the_world_coordinates = world_coordinates(46:-4:1,2:4);
[Re,Te,Xce,best_solutione]=efficient_pnp( the_world_coordinates, the_pixel_coordinates, cameraParams_Intrinsics );  

axis([-2.7 3 -1.5 3 0 4.5])

axis([0 3 0 3 0 1.5])

% indexes=[93,91,88,86,83, 80, 76, 72, 71, 70, 66, 64, 62, 59, 56, 53, 51, 48];
indexes=[93, 88, 86, 81, 71, 70, 65, 62, 56, 53, 48];
the_pixel_coordinates = pixel_coordinates( indexes    , 2:3 );
the_world_coordinates = world_coordinates( indexes-47 , 2:4);
[Re,Te,Xce,best_solutione]=efficient_pnp( the_world_coordinates, the_pixel_coordinates, cameraParams_Intrinsics );  

